@page "/order-management"

@using ArtStore.Shared.DTOs.Order.Events
@using Microsoft.AspNetCore.SignalR.Client
@using ArtStore.Shared.DTOs.Order
@using ArtStore.Shared.DTOs.Order.Commands
@using ArtStore.Shared.Models.Enums
@using ArtStore.UI.Client.Services
@using MudBlazor

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">Order Management</MudText>
        <MudChip T="string" Color="Color.Info" Size="Size.Medium">
            Updates: @_updateOrderCount
        </MudChip>
    </div>

    @if (Orders == null)
    {
        <div class="d-flex justify-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (!Orders.Any())
    {
        <MudAlert Severity="Severity.Info">
            No orders found.
        </MudAlert>
    }
    else
    {
        <MudDropContainer T="OrderDto" @ref="_dropContainer" Items="@Orders" ItemsSelector="@((item, column) => GetOrderStatus(item.Status) == column)" ItemDropped="OnOrderDropped" Class="d-flex flex-row" Style="width: 100%; gap: 8px;">
            <ChildContent>
                @foreach (var section in _kanbanSections)
                {
                    <MudPaper Elevation="0" MinHeight="700px" Class="pa-4 d-flex flex-column mud-background-gray rounded-lg kanban-column">
                        <MudToolBar Gutters="false" Class="@GetSectionHeaderClass(section.Status)" Style="padding: 16px;">
                            <MudIcon Icon="@GetSectionIcon(section.Status)" Class="mr-3" Size="Size.Large" />
                            <MudText Typo="Typo.h5" Style="color: white; font-weight: bold;">@(section.Name)</MudText>
                            <MudSpacer />
                            <MudChip T="string" Color="Color.Surface" Size="Size.Medium" Style="color: black; font-weight: bold; font-size: 14px;">
                                @GetOrdersByStatus(section.Status).Count()
                            </MudChip>
                        </MudToolBar>
                        <MudDropZone T="OrderDto" Identifier="@GetOrderStatus(section.Status)" Class="mud-height-full py-2" />
                    </MudPaper>
                }
            </ChildContent>
            <ItemRenderer>
                <MudPaper Elevation="6" Class="@($"pa-4 ma-2 rounded-lg {GetOrderCardCssClass(context.Status)}")" Style="min-height: 200px;">
                    <div class="d-flex justify-space-between align-center mb-3">
                        <MudText Typo="Typo.h6" Class="font-weight-bold" Style="font-size: 22px;">
                            #@context.OrderNumber | @context.CustomerName
                        </MudText>
                        <MudChip T="string" Color="Color.Primary" Size="Size.Medium" Variant="Variant.Outlined" Style="font-size: 12px;">
                            @context.OrderSource
                        </MudChip>
                    </div>

                    <MudText Typo="Typo.body2" Class="mud-text-secondary mb-3" Style="font-size: 14px;">
                        @context.OrderDate.ToString("HH:mm")
                    </MudText>

                    <MudDivider Class="my-3" />

                    <div class="mb-4">
                        <MudText Typo="Typo.body1" Class="mud-text-secondary mb-2" Style="font-size: 15px; font-weight: 500;">
                            Items: @context.OrderDetails.Sum(d => d.Quantity)
                        </MudText>

                        @if (context.OrderDetails.Any())
                        {
                            <div style="max-height: 140px; overflow-y: auto; padding: 8px 0;">
                                @foreach (var item in context.OrderDetails)
                                {
                                    <MudText Typo="Typo.body2" Class="d-block mb-1" Style="font-size: 20px; line-height: 1.6;">
                                        @($"{item.Quantity}x {item.ProductName}")
                                    </MudText>
                                }
                            </div>
                        }
                    </div>

                    <div class="d-flex justify-space-between align-center mt-3">
                        @if (CanMoveToNextStatus(context.Status))
                        {
                            <MudButton Size="Size.Medium"
                                       Variant="Variant.Filled"
                                       Color="@GetNextStatusButtonColor(context.Status)"
                                       StartIcon="@GetStatusActionIcon(context.Status)"
                                       OnClick="@(() => MoveOrderToNextStatus(context))"
                                       Style="height: 40px; font-size: 14px; font-weight: 600;">
                                @GetStatusActionText(context.Status)
                            </MudButton>
                        }
                        else
                        {
                            <MudSpacer />
                        }
                    </div>
                </MudPaper>
            </ItemRenderer>
        </MudDropContainer>
    }
</MudContainer>

@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject OrderService OrderService

<style>
    :root {
        --confirmed-color: #2196F3;
        --confirmed-color-dark: #1976D2;
        --processing-color: #FF9800;
        --processing-color-dark: #F57C00;
        --shipped-color: #4CAF50;
        --shipped-color-dark: #388E3C;
    }

    .order-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: grab;
        border-left: 6px solid var(--mud-palette-primary);
    }

        .order-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

    .order-card-confirmed {
        border-left: 6px solid var(--confirmed-color) !important;
    }

    .order-card-processing {
        border-left: 6px solid var(--processing-color) !important;
    }

    .order-card-shipped {
        border-left: 6px solid var(--shipped-color) !important;
    }

    .confirmed-section-header {
        background: linear-gradient(135deg, var(--confirmed-color) 0%, var(--confirmed-color-dark) 100%);
        border-radius: 8px;
        color: white !important;
    }

    .processing-section-header {
        background: linear-gradient(135deg, var(--processing-color) 0%, var(--processing-color-dark) 100%);
        border-radius: 8px;
        color: white !important;
    }

    .shipped-section-header {
        background: linear-gradient(135deg, var(--shipped-color) 0%, var(--shipped-color-dark) 100%);
        border-radius: 8px;
        color: white !important;
    }

    .kanban-column {
        flex: 1;
        min-width: 0;
        max-width: calc(33.333% - 6px);
    }

    @@media (min-width: 769px) and (max-width: 1200px) {
        /* Tablet styles */
        .kanban-column {
            max-width: calc(33.333% - 6px);
        }
    }

    @@media (max-width: 768px) {
        /* Mobile styles */
        .d-flex.flex-row {
            flex-direction: column !important;
            gap: 12px !important;
        }

        .kanban-column {
            max-width: 100% !important;
            margin: 0 !important;
            min-height: 400px !important;
        }

        .order-card {
            margin: 8px 0 !important;
        }

        .mud-toolbar {
            padding: 12px !important;
        }

        .mud-icon {
            margin-right: 8px !important;
        }
    }

    @@media (max-width: 480px) {
        /* Small mobile styles */
        .kanban-column {
            padding: 8px !important;
        }

        .order-card {
            padding: 12px !important;
            min-height: 160px !important;
        }
    }
</style>

@code {
    private MudDropContainer<OrderDto> _dropContainer = null!;

    public List<OrderDto>? Orders { get; set; }

    private int _updateOrderCount = 0;

    private HubConnection? _hubConnection;

    // Kanban sections definition
    private readonly List<KanbanSection> _kanbanSections = new()
    {
        new KanbanSection("Confirmed", OrderStatus.Confirmed),
        new KanbanSection("Processing", OrderStatus.Processing),
        new KanbanSection("Shipped", OrderStatus.Shipped)
    };

    public class KanbanSection
    {
        public string Name { get; init; }
        public OrderStatus Status { get; init; }

        public KanbanSection(string name, OrderStatus status)
        {
            Name = name;
            Status = status;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/orderManagementHub"))
            .Build();

        _hubConnection.On<OrderCreatedEvent>("OrderCreated", async (orderCreatedEvent) =>
        {
            Snackbar.Add($"Order #{orderCreatedEvent.OrderNumber} created successfully!", Severity.Success);

            await LoadOrdersAsync();

            _dropContainer?.Refresh();
            await InvokeAsync(StateHasChanged);
        });

        _hubConnection.On<OrderStatusChangedEvent>("OrderStatusChanged", async (orderStatusChangedEvent) =>
        {
            _updateOrderCount++;
            var updatedOrderItem = Orders?.Where(w => w.Id == orderStatusChangedEvent.OrderId).FirstOrDefault();
            if (updatedOrderItem is not null)
            {
                var oldStatus = updatedOrderItem.Status;
                updatedOrderItem.Status = orderStatusChangedEvent.NewStatus;

                _dropContainer?.Refresh();
                await InvokeAsync(StateHasChanged);

                Snackbar.Add(
                    $"Order #{orderStatusChangedEvent.OrderNumber} status changed to {GetStatusText(orderStatusChangedEvent.NewStatus)}.",
                    Severity.Info
                );
            }
            else
            {
                Snackbar.Add($"Order #{orderStatusChangedEvent.OrderNumber} updated but not found!", Severity.Warning);

                // If order not found locally, reload all orders to sync with server
                await LoadOrdersAsync();

                _dropContainer?.Refresh();
                await InvokeAsync(StateHasChanged);
            }
        });

        await LoadOrdersAsync();
        await _hubConnection.StartAsync();

        await InvokeAsync(StateHasChanged);
    }

    // MudDropContainer event handler
    private async Task OnOrderDropped(MudItemDropInfo<OrderDto> dropInfo)
    {
        try
        {
            var newStatus = ParseOrderStatus(dropInfo.DropzoneIdentifier);

            if (newStatus != dropInfo.Item.Status && IsValidStatusTransition(dropInfo.Item.Status, newStatus))
            {
                await UpdateOrderStatusInternal(dropInfo.Item, newStatus);
            }
            else if (newStatus != dropInfo.Item.Status)
            {
                Snackbar.Add("Status transition not allowed", Severity.Warning);
                _dropContainer?.Refresh();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error dropping order: {ex.Message}");
            Snackbar.Add("Error updating order status", Severity.Error);
            _dropContainer?.Refresh();
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadOrdersAsync()
    {
        try
        {
            Orders = await OrderService.GetOrdersAsync();
        }
        catch (Exception ex)
        {
            // Handle exceptions (e.g., log error, show message)
            Console.Error.WriteLine($"Error loading orders: {ex.Message}");
        }
    }


    private Color GetStatusColor(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => Color.Warning,
            OrderStatus.Confirmed => Color.Info,
            OrderStatus.Processing => Color.Primary,
            OrderStatus.Shipped => Color.Secondary,
            OrderStatus.Delivered => Color.Success,
            OrderStatus.Cancelled => Color.Error,
            OrderStatus.Refunded => Color.Dark,
            _ => Color.Default
        };
    }

    private string GetStatusText(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Pending => "Pending",
            OrderStatus.Confirmed => "Confirmed",
            OrderStatus.Processing => "Processing",
            OrderStatus.Shipped => "Shipped",
            OrderStatus.Delivered => "Delivered",
            OrderStatus.Cancelled => "Cancelled",
            OrderStatus.Refunded => "Refunded",
            _ => status.ToString()
        };
    }

    private string GetPaymentIcon(PaymentMethodType paymentMethod)
    {
        return paymentMethod switch
        {
            PaymentMethodType.None => Icons.Material.Filled.HelpOutline,
            PaymentMethodType.Cash => Icons.Material.Filled.Money,
            PaymentMethodType.DebitCard => Icons.Material.Filled.Payment,
            PaymentMethodType.CreditCard => Icons.Material.Filled.CreditCard,
            PaymentMethodType.Bitcoin => Icons.Material.Filled.CurrencyBitcoin,
            PaymentMethodType.USDT => Icons.Material.Filled.AttachMoney,
            _ => Icons.Material.Filled.Payment
        };
    }

    private string GetPaymentMethodText(PaymentMethodType paymentMethod)
    {
        return paymentMethod switch
        {
            PaymentMethodType.None => "Undefined",
            PaymentMethodType.Cash => "Cash",
            PaymentMethodType.DebitCard => "Debit Card",
            PaymentMethodType.CreditCard => "Credit Card",
            PaymentMethodType.Bitcoin => "Bitcoin",
            PaymentMethodType.USDT => "USDT",
            _ => paymentMethod.ToString()
        };
    }

    private async Task UpdateOrderStatus(OrderDto order)
    {
        try
        {
            var newStatus = order.Status switch
            {
                OrderStatus.Confirmed => OrderStatus.Processing,
                OrderStatus.Processing => OrderStatus.Shipped,
                _ => order.Status
            };

            if (newStatus != order.Status)
            {
                var command = new UpdateOrderStatusCommand
                {
                    OrderId = order.Id,
                    Status = newStatus
                };

                var success = await OrderService.UpdateOrderStatusAsync(command);
                if (success)
                {
                    order.Status = newStatus;
                    await InvokeAsync(StateHasChanged);
                }
                // Optionally handle failure (e.g., show a message)
            }
        }
        catch (Exception ex)
        {
            // Handle exceptions (e.g., log error, show message)
            Console.Error.WriteLine($"Error updating order status: {ex.Message}");
        }
    }

    private string GetOrderActionText(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => "Process",
            OrderStatus.Processing => "Ship",
            _ => ""
        };
    }

    private string GetOrderActionIcon(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => Icons.Material.Filled.PlayArrow,
            OrderStatus.Processing => Icons.Material.Filled.LocalShipping,
            _ => ""
        };
    }

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }

    private string GetOrderButtonStyle(OrderStatus status)
    {
        return status == OrderStatus.Shipped
            ? "min-width: 120px; display:none;"
            : "min-width: 120px;";
    }

    // New methods for MudDropContainer Kanban
    private string GetOrderStatus(OrderStatus status)
    {
        return status.ToString();
    }

    private OrderStatus ParseOrderStatus(string statusString)
    {
        return Enum.Parse<OrderStatus>(statusString);
    }

    private IEnumerable<OrderDto> GetOrdersByStatus(OrderStatus status)
    {
        return Orders?.Where(o => o.Status == status).OrderBy(o => o.OrderDate) ?? Enumerable.Empty<OrderDto>();
    }

    private string GetSectionHeaderClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => "confirmed-section-header",
            OrderStatus.Processing => "processing-section-header",
            OrderStatus.Shipped => "shipped-section-header",
            _ => ""
        };
    }

    private string GetSectionIcon(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => Icons.Material.Filled.CheckCircle,
            OrderStatus.Processing => Icons.Material.Filled.Autorenew,
            OrderStatus.Shipped => Icons.Material.Filled.LocalShipping,
            _ => Icons.Material.Filled.Circle
        };
    }

    private bool CanMoveToNextStatus(OrderStatus currentStatus)
    {
        return currentStatus == OrderStatus.Confirmed || currentStatus == OrderStatus.Processing;
    }

    private OrderStatus GetNextStatus(OrderStatus currentStatus)
    {
        return currentStatus switch
        {
            OrderStatus.Confirmed => OrderStatus.Processing,
            OrderStatus.Processing => OrderStatus.Shipped,
            _ => currentStatus
        };
    }

    private string GetStatusActionText(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => "Process",
            OrderStatus.Processing => "Ship",
            _ => ""
        };
    }

    private string GetStatusActionIcon(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => Icons.Material.Filled.PlayArrow,
            OrderStatus.Processing => Icons.Material.Filled.LocalShipping,
            _ => ""
        };
    }

    private async Task MoveOrderToNextStatus(OrderDto order)
    {
        if (!CanMoveToNextStatus(order.Status))
            return;

        try
        {
            var newStatus = GetNextStatus(order.Status);

            await UpdateOrderStatusInternal(order, newStatus);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error moving order to next status: {ex.Message}");
            Snackbar.Add("Error updating order status", Severity.Error);
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private bool IsValidStatusTransition(OrderStatus from, OrderStatus to)
    {
        return (from, to) switch
        {
            (OrderStatus.Confirmed, OrderStatus.Processing) => true,
            (OrderStatus.Processing, OrderStatus.Shipped) => true,
            (OrderStatus.Processing, OrderStatus.Confirmed) => true, // Allow backward movement
            (OrderStatus.Shipped, OrderStatus.Processing) => true, // Allow backward movement
            _ => false
        };
    }

    private async Task UpdateOrderStatusInternal(OrderDto order, OrderStatus newStatus)
    {
        var command = new UpdateOrderStatusCommand
        {
            OrderId = order.Id,
            Status = newStatus
        };

        var success = await OrderService.UpdateOrderStatusAsync(command);
        if (success)
        {
            order.Status = newStatus;
            _dropContainer?.Refresh();
        }
        else
        {
            Snackbar.Add("Failed to update order status", Severity.Error);
        }
    }

    private string GetOrderCardCssClass(OrderStatus status)
    {
        return status switch
        {
            OrderStatus.Confirmed => "order-card order-card-confirmed",
            OrderStatus.Processing => "order-card order-card-processing",
            OrderStatus.Shipped => "order-card order-card-shipped",
            _ => "order-card"
        };
    }

    private Color GetNextStatusButtonColor(OrderStatus currentStatus)
    {
        var nextStatus = GetNextStatus(currentStatus);
        return nextStatus switch
        {
            OrderStatus.Processing => Color.Warning,
            OrderStatus.Shipped => Color.Success,
            _ => Color.Primary
        };
    }
}